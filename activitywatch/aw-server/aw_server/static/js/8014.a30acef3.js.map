{"version":3,"file":"js/8014.a30acef3.js","mappings":"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","sources":["webpack://aw-webui/./src/views/TimespiralView.vue","webpack://aw-webui/./src/visualizations/Timespiral.vue","webpack://aw-webui/./src/visualizations/Timespiral.vue?fe9a","webpack://aw-webui/./src/visualizations/Timespiral.vue?2ad4","webpack://aw-webui/./src/visualizations/Timespiral.vue?6540","webpack://aw-webui/./src/views/TimespiralView.vue?e77d","webpack://aw-webui/./src/views/TimespiralView.vue?cec3","webpack://aw-webui/./src/views/TimespiralView.vue?c2ef","webpack://aw-webui/./node_modules/lodash/cloneDeep.js","webpack://aw-webui/./node_modules/lodash/map.js","webpack://aw-webui/./node_modules/@babel/runtime/helpers/esm/arrayWithoutHoles.js","webpack://aw-webui/./node_modules/@babel/runtime/helpers/esm/iterableToArray.js","webpack://aw-webui/./node_modules/@babel/runtime/helpers/esm/nonIterableSpread.js","webpack://aw-webui/./node_modules/@babel/runtime/helpers/esm/toConsumableArray.js"],"sourcesContent":["var render = function render(){var _vm=this,_c=_vm._self._c;return _c('div',[_c('h1',[_vm._v(\"Timespiral\")]),_c('b-alert',{attrs:{\"show\":\"\",\"variant\":\"info\"}},[_vm._v(\"This is a work-in-progress experiment.\")]),_c('div',[_vm._v(\"Bucket: \"+_vm._s(_vm.bucketId))]),_c('div',[_vm._v(\"Events: \"+_vm._s(_vm.events.length))]),_c('Timespiral',{attrs:{\"events\":_vm.events}})],1)\n}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","var render = function render(){var _vm=this,_c=_vm._self._c;return _c('div',[_c('svg',{attrs:{\"id\":\"timespiral\"}})])\n}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","\n// This component renders an interactive \"timespiral\" where each turn of the \"loop\" is a 24h day.\n// The spiral can be zoomed in/out, to display different days.\n// Somewhat inspired by Apple's Time Machine UI.\n//\n// Similar things done with D3 here:\n//  - http://bl.ocks.org/larsenmtl/222043d93a41d48b58d2bfa1e3d4f708\n//  - https://observablehq.com/@mydu/spiral-arc-chart\n//  - https://bl.ocks.org/tomshanley/4080b28445785939b3f043b8c5b63e22\n\nimport * as d3 from 'd3';\nimport { PieArcDatum } from 'd3-shape';\nimport moment from 'moment';\nimport { IEvent } from '~/util/interfaces';\n\nfunction split_events_on_hours(events: IEvent[]): IEvent[] {\n  // Takes a list of events, finds events that crosses hour-boundaries (e.g. 01:00, or 23:00)\n  // and splits them into two (or more) events, one plus one per hour boundary crossed.\n  //\n  // Returns a list of events, with the original events intact, and the new events added.\n\n  // Deepcopy\n  events = JSON.parse(JSON.stringify(events));\n\n  // First we need to find them, and filter them away from the other events.\n  const crossing_events = events.filter(e => {\n    // Does the event cross an hour mark?\n    const start = moment(e.timestamp);\n    const end = moment(e.timestamp).add(e.duration, 'seconds');\n    return !start.isSame(end, 'hour');\n  });\n\n  const split_events = crossing_events\n    .map(e => {\n      // Split the event into at least two events, one more for each additional hour boundary crossed.\n      const start = moment(e.timestamp);\n      const end = moment(e.timestamp).add(e.duration, 'seconds');\n\n      // We handle the start and end bits first, as they are not whole hours.\n      const new_events: IEvent[] = [\n        // First split event just needs to end at the end of the start hour.\n        {\n          ...e,\n          duration: moment(start).startOf('hour').add(1, 'hour').diff(start, 'seconds'),\n        },\n        // Last split event just needs to start at the beginning of the end hour.\n        {\n          ...e,\n          timestamp: moment(end).startOf('hour').format(),\n          duration: moment(end).diff(end.startOf('hour'), 'seconds'),\n        },\n      ];\n\n      // Now we handle the middle bits.\n      for (\n        let ts = start.startOf('hour').add(1, 'hour');\n        ts < end.startOf('hour');\n        ts.add(1, 'hour')\n      ) {\n        const new_e = {\n          ...e,\n          timestamp: ts.format(),\n          duration: 60 * 60,\n        };\n        new_events.push(new_e);\n      }\n\n      return new_events;\n    })\n    .reduce((a, b) => a.concat(b), []); // flatten\n\n  // Return the sorted list of: original events, without the crossing events, and with the new split events added.\n  return (\n    events\n      .filter(e => !crossing_events.includes(e))\n      .concat(split_events)\n      // TypeScript won't let me sort this with -, for some reason\n      .sort((a, b) => {\n        const a_start = moment(a.timestamp);\n        const b_start = moment(b.timestamp);\n        return a_start.diff(b_start);\n      })\n      .reverse()\n  );\n}\n\nexport default {\n  name: 'Timespiral',\n  props: { events: { type: Array, default: () => [] } },\n  data() {\n    return {};\n  },\n  computed: {\n    split_on_hour() {\n      if (this.events && this.events.length > 0) {\n        return split_events_on_hours(this.events);\n      } else {\n        return [];\n      }\n    },\n  },\n  watch: {\n    events() {\n      this.renderChart();\n    },\n  },\n  mounted() {\n    this.renderChart();\n  },\n  updated() {\n    this.renderChart();\n  },\n  beforeUpdate() {\n    const svg = d3.select('svg');\n    svg.selectAll('*').remove();\n  },\n  methods: {\n    renderChart() {\n      if (this.events.length == 0) return;\n\n      // Gets a deepcopy of events\n      let events = this.split_on_hour;\n\n      // Constants\n      const height = 600;\n      const width = 600;\n      const margin = 60;\n      const max_days = 5; // the maximum number of days to show\n      const thickness = 250 / max_days; // thickness of spiral arms\n      const spacing = 20; // spacing between spiral arms\n      const min_radius = thickness + spacing + 20;\n\n      // Init d3\n      const svg = d3\n        .select('svg#timespiral')\n        .style('height', `${height}px`)\n        .style('width', `${width}px`);\n\n      const g = svg.append('g').attr('transform', `translate(${width / 2}, ${width / 2})`);\n\n      // The domain is the range of the data.\n      // We need to stretch it such that it ranges all the days in events, from start of day to end of day.\n      const eventdomain = d3.extent(events.map((e: IEvent) => e.timestamp));\n\n      const _domain_start = moment(eventdomain[0]).startOf('day');\n      const _domain_end = moment(eventdomain[1]).endOf('day');\n\n      // Limit the events to max_days\n      let domain;\n      if (_domain_end.clone().diff(_domain_start) / 1000 > max_days) {\n        domain = [_domain_end.clone().subtract(max_days, 'days'), _domain_end];\n      } else {\n        domain = [_domain_start, _domain_end];\n      }\n      const nbSpirals = Math.ceil(\n        (domain[1].valueOf() - domain[0].valueOf()) / (24 * 60 * 60 * 1000)\n      );\n\n      events = events.filter(e => moment(e.timestamp).isAfter(domain[0]));\n\n      // To generate a spiral, we need two scales. One for the angle, and one for the radius.\n\n      // The angle\n      const xScale = d3\n        .scaleTime()\n        .domain(domain)\n        .range([0, 2 * Math.PI * nbSpirals]);\n\n      // The radius\n      const yScale = d3\n        .scaleTime()\n        .domain(domain)\n        .range([\n          min_radius + (width - margin) / 2 - (thickness + spacing) * nbSpirals,\n          (width - margin * 2) / 2,\n        ]);\n\n      const thickScale = d3\n        .scalePow()\n        .exponent(2)\n        .domain(domain)\n        .range([thickness / (max_days - 1), thickness]);\n\n      // We want to add some spacing at hour-boundaries,\n      // to do this we compress the startAngle and endAngle of each hour-segment, around the hour-center, by 1%.\n      events.forEach(d => {\n        d.startAngle = xScale(new Date(d.timestamp));\n        d.endAngle = xScale(new Date(d.timestamp).valueOf() + 1000 * d.duration);\n\n        // Compress the angles around the hour-center.\n        const gap = 0.05;\n        const hour = moment(d.timestamp).startOf('hour');\n\n        // This kinda works? But also kinda breaks as it seems to lead to overlap\n        // FIXME: Get rid of overlap bug\n        d.startAngle += (d.startAngle - xScale(hour)) * gap;\n        d.endAngle -= (d.endAngle - xScale(hour)) * gap;\n      });\n\n      // It seems very difficult to make proper smooth spiral arcs with D3.\n      // Instead, we can split events on hour marks and leave a gap (helpful for readability).\n      // Events within the same hour share the same radius/y, to give it the appearance of hour-segments.\n\n      // Events have been split by `split_on_hour` above.\n\n      // Computes the radius and spiral thickness for a particular event.\n      // Each inner spiral (previous day) should get progressively thinner.\n      function spiralThickness(timestamp: string, staggered: boolean): [number, number] {\n        const hourstart = staggered\n          ? moment(timestamp).startOf('hour').valueOf()\n          : moment(timestamp).valueOf();\n        return [yScale(hourstart), thickScale(hourstart)]; // the radius and thickness of the spiral at timestamp\n      }\n\n      const arcGen = d3\n        .arc<PieArcDatum<number>>()\n        // Compute the radius of each event, rounded to the hour in which the event occurs.\n        .innerRadius(d => {\n          const [radius, thick] = spiralThickness(events[d.data].timestamp, true);\n          return radius - thick / 2;\n        })\n        .outerRadius(d => {\n          const [radius, thick] = spiralThickness(events[d.data].timestamp, true);\n          return radius + thick / 2;\n        })\n        // Makes corners round and pretty\n        .cornerRadius(2);\n\n      events.forEach((e: IEvent & { startAngle: number; endAngle: number }, i) => {\n        // TODO: Draw as polygon-segments instead?\n        // Would give us control of start/end points so we can make them align prettily.\n        const gradientArcs = d3\n          .pie<number>()\n          .sort(null)\n          .startAngle(e.startAngle)\n          .endAngle(e.endAngle)\n          .value(moment(e.timestamp).valueOf())([i]);\n\n        // Can be used to draw a dot\n        /*\n        const hourstart = moment(e.timestamp).startOf('hour').add(30, 'minutes').valueOf();\n        const a = xScale(hourstart);\n        const r = yScale(hourstart);\n        const x = r * Math.cos(a);\n        const y = r * Math.sin(a);\n\n        g.selectAll('circle')\n          .data([[x, y]])\n          .enter()\n          .append('circle')\n          .attr('cx', d => d[0])\n          .attr('cy', d => d[1])\n          .attr('r', '8px')\n          .attr('fill', 'red');\n        */\n\n        // Append the arc\n        // TODO: Rotate arcs slightly so that arc ends are facing each other (is this even possible)\n        g.append('g')\n          .selectAll('path')\n          .data(gradientArcs)\n          .join('path')\n          .attr('d', arcGen as any)\n          .attr('stroke', 'none')\n          // NOTE: Attempted rotation around a pivot point, doesn't work\n          //.attr('transform', `rotate(-5 ${x} ${y})`)\n          // TODO: Colors should come from events (retrievable by query), not hardcoded\n          .attr('fill', e.data.status == 'not-afk' ? '#0d0' : '#ccc')\n          .attr('opacity', 0.7);\n      });\n\n      const labelColor = '#888';\n      const tickColor = '#ccc';\n\n      // Draw clock ticks\n      // Modified from sunburst-clock.js\n      function drawClockTick(group, a, radius, inner: boolean) {\n        const xn = Math.cos(a);\n        const yn = Math.sin(a);\n\n        // TODO: Use radius for the last event as a starting point,\n        //       not the radius as if the day was full of events.\n        //       Maybe even have the max radius be radius of the last event,\n        //       with radius matching the last event for a certain time.\n        group\n          .append('line')\n          .attr('x1', (radius - 5) * xn)\n          .attr('y1', (radius - 5) * yn)\n          .attr('x2', (radius + 5) * xn)\n          .attr('y2', (radius + 5) * yn)\n          .style('stroke', tickColor)\n          .style('stroke-width', 2);\n\n        if (inner)\n          group\n            .append('line')\n            .attr('x1', 0)\n            .attr('y1', 0)\n            .attr('x2', (radius - 5) * xn)\n            .attr('y2', (radius - 5) * yn)\n            .style('stroke', '#fff')\n            .style('stroke-width', 2);\n      }\n\n      function drawClock(group, h, m, text, radius, inner: boolean) {\n        const a = 2 * Math.PI * (h / 24 + m / 24 / 60) - (1 / 2) * Math.PI;\n        drawClockTick(g, a, radius, inner);\n\n        const xn = Math.cos(a);\n        const yn = Math.sin(a);\n\n        group\n          .append('text')\n          .text(text || moment({ hours: h }).format('HH:mm'))\n          // Fall back to middle,\n          // but should be right for 18:00 and left for 06:00.\n          .attr('text-anchor', h == 6 ? 'start' : h == 18 ? 'end' : 'middle')\n          .attr('dominant-baseline', 'middle')\n          .attr('font-size', '1em')\n          //.attr(\"font-weight\", \"bold\")\n          .style('fill', labelColor)\n          .attr('x', (radius + 10) * xn)\n          .attr('y', (radius + 20) * yn);\n      }\n\n      const max_radius = yScale(domain[1]);\n      drawClock(g, 0, 0, '00:00', max_radius, true);\n      drawClock(g, 3, 0, '', max_radius);\n      drawClock(g, 6, 0, '06:00', max_radius, true);\n      drawClock(g, 9, 0, '', max_radius);\n      drawClock(g, 12, 0, '12:00', max_radius, true);\n      drawClock(g, 15, 0, '', max_radius);\n      drawClock(g, 18, 0, '18:00', max_radius, true);\n      drawClock(g, 21, 0, '', max_radius);\n\n      const now = moment();\n      drawClock(g, now.hour(), now.minute(), 'Now', max_radius);\n\n      // Draw date labels\n      // We want to draw date-labels at the start of the spiral for each day (at 00:00)\n\n      function drawDate(group, date) {\n        const radius = yScale(moment(date).add(8, 'hours'));\n        const radius_next_quad = yScale(moment(date).add(14, 'hours'));\n        const radius_diff = (radius_next_quad - radius) / 4;\n        const m = moment(date).startOf('day');\n\n        const pathid = `wavy${date.valueOf()}`;\n        const path = `M 2,-${radius} A ${radius + radius_diff},${\n          radius + radius_diff\n        } 0 0 1 ${radius_next_quad},0`;\n\n        group\n          .append('path')\n          .attr('id', pathid) //Unique id of the path\n          .attr('d', path) //SVG path\n          //.attr('d', 'M 0,-100 A 100,100 0 0 1 110,0') //SVG path\n          .style('fill', 'none')\n          .style('stroke', '#AAAAAA')\n          .style('stroke-width', 0);\n\n        group\n          .append('text')\n          .append('textPath')\n          .text(m.format('Y-M-D'))\n          .attr('xlink:href', `#${pathid}`)\n          .attr('text-anchor', 'left')\n          //.attr('dominant-baseline', 'middle')\n          .attr('font-size', `${1 * Math.max(thickScale(m) / thickness, 0.5)}em`)\n          //.attr('text-decoration', 'underline');\n          .style('fill', '#555');\n      }\n\n      const date_labels = d3.timeDays(...domain);\n      date_labels.forEach(d => drawDate(g, d));\n\n      // From: https://stackoverflow.com/a/49097025/965332\n      // Might serve as a base for later improvements\n      function makeSpiral(group, quarterTurns) {\n        const pointsPerQuarter = 90;\n        const points = [];\n\n        for (let i = 0; i < quarterTurns * pointsPerQuarter; i++) {\n          const angle = (i * Math.PI) / 2 / pointsPerQuarter;\n          const timestamp = xScale.invert(angle);\n          const [radius, _thickness] = spiralThickness(timestamp);\n          const line_margin = _thickness / 4;\n          points.push((radius - line_margin) * Math.cos(angle));\n          points.push((radius - line_margin) * Math.sin(angle));\n        }\n        group\n          .append('polyline')\n          .attr('points', points.join(' '))\n          .attr('stroke', '#ccc')\n          .attr('stroke-width', 1)\n          .attr('fill', 'none');\n      }\n\n      makeSpiral(g, nbSpirals * 4 - 1);\n    },\n  },\n};\n","import mod from \"-!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/ts-loader/index.js??clonedRuleSet-38.use[2]!../../node_modules/@vue/vue-loader-v15/lib/index.js??vue-loader-options!./Timespiral.vue?vue&type=script&lang=ts&\"; export default mod; export * from \"-!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/ts-loader/index.js??clonedRuleSet-38.use[2]!../../node_modules/@vue/vue-loader-v15/lib/index.js??vue-loader-options!./Timespiral.vue?vue&type=script&lang=ts&\"","import { render, staticRenderFns } from \"./Timespiral.vue?vue&type=template&id=3a5a7c6e&lang=pug&\"\nimport script from \"./Timespiral.vue?vue&type=script&lang=ts&\"\nexport * from \"./Timespiral.vue?vue&type=script&lang=ts&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/@vue/vue-loader-v15/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\nexport default component.exports","\nimport { useBucketsStore } from '~/stores/buckets';\nimport Timespiral from '~/visualizations/Timespiral.vue';\n\nexport default {\n  name: 'TimespiralView',\n  components: {\n    Timespiral,\n  },\n  data() {\n    return {\n      events: [],\n      bucketId: '',\n    };\n  },\n  async mounted() {\n    const bucketStore = useBucketsStore();\n    await bucketStore.ensureLoaded();\n    const buckets = bucketStore.bucketsAFK(bucketStore.hosts[0]);\n    if (buckets.length == 0) {\n      console.warn(\"Couldn't find suitable bucket\");\n      return;\n    }\n    this.bucketId = buckets[0];\n\n    const bucket = await bucketStore.getBucketWithEvents({\n      id: this.bucketId,\n      start: new Date('2022-08-08'),\n    });\n    this.events = bucket.events;\n    console.log('Retrieved events:', this.events);\n    console.log('First/last event:', this.events[0], this.events[this.events.length - 1]);\n  },\n  methods: {\n    onEventClick(event) {\n      this.$store.commit('setSelectedEvent', event);\n      this.$router.push({ name: 'EventView' });\n    },\n  },\n};\n","import mod from \"-!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/ts-loader/index.js??clonedRuleSet-38.use[2]!../../node_modules/@vue/vue-loader-v15/lib/index.js??vue-loader-options!./TimespiralView.vue?vue&type=script&lang=ts&\"; export default mod; export * from \"-!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/ts-loader/index.js??clonedRuleSet-38.use[2]!../../node_modules/@vue/vue-loader-v15/lib/index.js??vue-loader-options!./TimespiralView.vue?vue&type=script&lang=ts&\"","import { render, staticRenderFns } from \"./TimespiralView.vue?vue&type=template&id=9e8877c8&lang=pug&\"\nimport script from \"./TimespiralView.vue?vue&type=script&lang=ts&\"\nexport * from \"./TimespiralView.vue?vue&type=script&lang=ts&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/@vue/vue-loader-v15/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\nexport default component.exports","var baseClone = require('./_baseClone');\n\n/** Used to compose bitmasks for cloning. */\nvar CLONE_DEEP_FLAG = 1,\n    CLONE_SYMBOLS_FLAG = 4;\n\n/**\n * This method is like `_.clone` except that it recursively clones `value`.\n *\n * @static\n * @memberOf _\n * @since 1.0.0\n * @category Lang\n * @param {*} value The value to recursively clone.\n * @returns {*} Returns the deep cloned value.\n * @see _.clone\n * @example\n *\n * var objects = [{ 'a': 1 }, { 'b': 2 }];\n *\n * var deep = _.cloneDeep(objects);\n * console.log(deep[0] === objects[0]);\n * // => false\n */\nfunction cloneDeep(value) {\n  return baseClone(value, CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG);\n}\n\nmodule.exports = cloneDeep;\n","var arrayMap = require('./_arrayMap'),\n    baseIteratee = require('./_baseIteratee'),\n    baseMap = require('./_baseMap'),\n    isArray = require('./isArray');\n\n/**\n * Creates an array of values by running each element in `collection` thru\n * `iteratee`. The iteratee is invoked with three arguments:\n * (value, index|key, collection).\n *\n * Many lodash methods are guarded to work as iteratees for methods like\n * `_.every`, `_.filter`, `_.map`, `_.mapValues`, `_.reject`, and `_.some`.\n *\n * The guarded methods are:\n * `ary`, `chunk`, `curry`, `curryRight`, `drop`, `dropRight`, `every`,\n * `fill`, `invert`, `parseInt`, `random`, `range`, `rangeRight`, `repeat`,\n * `sampleSize`, `slice`, `some`, `sortBy`, `split`, `take`, `takeRight`,\n * `template`, `trim`, `trimEnd`, `trimStart`, and `words`\n *\n * @static\n * @memberOf _\n * @since 0.1.0\n * @category Collection\n * @param {Array|Object} collection The collection to iterate over.\n * @param {Function} [iteratee=_.identity] The function invoked per iteration.\n * @returns {Array} Returns the new mapped array.\n * @example\n *\n * function square(n) {\n *   return n * n;\n * }\n *\n * _.map([4, 8], square);\n * // => [16, 64]\n *\n * _.map({ 'a': 4, 'b': 8 }, square);\n * // => [16, 64] (iteration order is not guaranteed)\n *\n * var users = [\n *   { 'user': 'barney' },\n *   { 'user': 'fred' }\n * ];\n *\n * // The `_.property` iteratee shorthand.\n * _.map(users, 'user');\n * // => ['barney', 'fred']\n */\nfunction map(collection, iteratee) {\n  var func = isArray(collection) ? arrayMap : baseMap;\n  return func(collection, baseIteratee(iteratee, 3));\n}\n\nmodule.exports = map;\n","import arrayLikeToArray from \"./arrayLikeToArray.js\";\nexport default function _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) return arrayLikeToArray(arr);\n}","export default function _iterableToArray(iter) {\n  if (typeof Symbol !== \"undefined\" && iter[Symbol.iterator] != null || iter[\"@@iterator\"] != null) return Array.from(iter);\n}","export default function _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}","import arrayWithoutHoles from \"./arrayWithoutHoles.js\";\nimport iterableToArray from \"./iterableToArray.js\";\nimport unsupportedIterableToArray from \"./unsupportedIterableToArray.js\";\nimport nonIterableSpread from \"./nonIterableSpread.js\";\nexport default function _toConsumableArray(arr) {\n  return arrayWithoutHoles(arr) || iterableToArray(arr) || unsupportedIterableToArray(arr) || nonIterableSpread();\n}"],"names":["render","_vm","this","_c","_self","_v","attrs","_s","bucketId","events","length","staticRenderFns","split_events_on_hours","JSON","parse","stringify","crossing_events","filter","e","start","moment","timestamp","end","add","duration","isSame","split_events","map","new_events","startOf","diff","format","ts","new_e","push","reduce","a","b","concat","includes","sort","a_start","b_start","reverse","name","props","type","Array","default","data","computed","split_on_hour","watch","renderChart","mounted","updated","beforeUpdate","svg","d3","select","selectAll","remove","methods","domain","height","width","margin","max_days","thickness","spacing","min_radius","style","g","append","attr","eventdomain","extent","_domain_start","_domain_end","endOf","clone","subtract","nbSpirals","Math","ceil","valueOf","isAfter","xScale","range","PI","yScale","thickScale","exponent","forEach","d","startAngle","Date","endAngle","gap","hour","arcGen","innerRadius","spiralThickness","radius","thick","outerRadius","cornerRadius","i","gradientArcs","value","join","status","labelColor","tickColor","max_radius","drawClock","now","minute","date_labels","timeDays","drawDate","makeSpiral","staggered","hourstart","drawClockTick","group","inner","xn","cos","yn","sin","h","m","text","hours","date","radius_next_quad","radius_diff","pathid","path","max","quarterTurns","pointsPerQuarter","points","angle","invert","_thickness","line_margin","component","components","Timespiral","bucketStore","useBucketsStore","ensureLoaded","buckets","bucketsAFK","hosts","console","warn","getBucketWithEvents","id","bucket","log","onEventClick","event","$store","commit","$router","baseClone","CLONE_DEEP_FLAG","CLONE_SYMBOLS_FLAG","cloneDeep","module","exports","arrayMap","baseIteratee","baseMap","isArray","collection","iteratee","func","_arrayWithoutHoles","arr","arrayLikeToArray","_iterableToArray","iter","Symbol","iterator","from","_nonIterableSpread","TypeError","_toConsumableArray","arrayWithoutHoles","iterableToArray","unsupportedIterableToArray","nonIterableSpread"],"sourceRoot":""}